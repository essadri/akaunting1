name: DevSecOps Pipeline - Akaunting

on:
  workflow_dispatch:

jobs:
  ci:
    name: CI - Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        run: docker build -t akaunting-app .

  sast:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    needs: ci
    
    # ========== DEFECTDOJO CONFIGURATION ==========
    env:
      DEFECTDOJO_URL: 'http://35.175.208.95:8080'
      DEFECTDOJO_TOKEN: '737047c42f6999f1b18b170baa677d1beb05f889'
      DEFECTDOJO_PRODUCT_ID: '1'
      DEFECTDOJO_ENGAGEMENT_ID: '1'
    # ==============================================

    steps:
      - uses: actions/checkout@v4
      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep
      - name: Semgrep JSON
        run: |
          semgrep scan \
            --config p/php \
            --config p/javascript \
            --json \
            --output semgrep.json \
            .
      - name: Semgrep SARIF
        run: |
          semgrep scan \
            --config p/php \
            --config p/javascript \
            --sarif \
            --output semgrep.sarif \
            .
      - name: Upload SAST report
        uses: actions/upload-artifact@v4
        with:
          name: sast-semgrep-report
          path: |
            semgrep.json
            semgrep.sarif
      
      # ========== UPLOAD TO DEFECTDOJO ==========
      - name: Upload SAST to DefectDojo
        if: always()
        run: |
          echo "üì§ Uploading SAST report to DefectDojo..."
          
          if [ -f semgrep.json ]; then
            echo "‚úÖ Found semgrep.json file"
            
            curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DEFECTDOJO_TOKEN" \
              -F "engagement=$DEFECTDOJO_ENGAGEMENT_ID" \
              -F "product=$DEFECTDOJO_PRODUCT_ID" \
              -F "scan_type=Semgrep JSON Report" \
              -F "file=@semgrep.json" \
              --max-time 30 \
              || echo "‚ö†Ô∏è  SAST upload had issues, but continuing..."
              
            echo "‚úÖ SAST upload attempt completed"
          else
            echo "‚ùå semgrep.json not found, skipping upload"
          fi
      # ==========================================

  sca:
    name: SCA - Trivy
    runs-on: ubuntu-latest
    needs: ci
    
    # ========== DEFECTDOJO CONFIGURATION ==========
    env:
      DEFECTDOJO_URL: 'http://35.175.208.95:8080'
      DEFECTDOJO_TOKEN: '737047c42f6999f1b18b170baa677d1beb05f889'
      DEFECTDOJO_PRODUCT_ID: '1'
      DEFECTDOJO_ENGAGEMENT_ID: '1'
    # ==============================================

    steps:
      - uses: actions/checkout@v4
      - run: docker build -t akaunting-app .
      - name: Trivy JSON
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: akaunting-app
          format: json
          output: trivy-report.json
          severity: HIGH,CRITICAL
          exit-code: 0
      - name: Trivy Table
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --format table \
            akaunting-app > trivy-report.txt
      - name: Upload SCA report
        uses: actions/upload-artifact@v4
        with:
          name: sca-trivy-report
          path: |
            trivy-report.json
            trivy-report.txt
      
      # ========== UPLOAD TO DEFECTDOJO ==========
      - name: Upload SCA to DefectDojo
        if: always()
        run: |
          echo "üì§ Uploading SCA report to DefectDojo..."
          
          if [ -f trivy-report.json ]; then
            echo "‚úÖ Found trivy-report.json file"
            
            curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DEFECTDOJO_TOKEN" \
              -F "engagement=$DEFECTDOJO_ENGAGEMENT_ID" \
              -F "product=$DEFECTDOJO_PRODUCT_ID" \
              -F "scan_type=Trivy Scan" \
              -F "file=@trivy-report.json" \
              --max-time 30 \
              || echo "‚ö†Ô∏è  SCA upload had issues, but continuing..."
              
            echo "‚úÖ SCA upload attempt completed"
          else
            echo "‚ùå trivy-report.json not found, skipping upload"
          fi
      # ==========================================

  dast:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    
    # ========== DEFECTDOJO CONFIGURATION ==========
    env:
      DEFECTDOJO_URL: 'http://35.175.208.95:8080'
      DEFECTDOJO_TOKEN: '737047c42f6999f1b18b170baa677d1beb05f889'
      DEFECTDOJO_PRODUCT_ID: '1'
      DEFECTDOJO_ENGAGEMENT_ID: '1'
    # ==============================================

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Start application
        run: |
          docker compose up --build -d
          sleep 90
      - name: Verify app is reachable
        run: |
          curl -I http://localhost:8000
      - name: Pull OWASP ZAP image
        run: |
          docker pull ghcr.io/zaproxy/zaproxy:stable
      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --network=host \
            --user root \
            -v ${{ github.workspace }}:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://localhost:8000 \
            -r zap-report.html \
            -J zap-report.json \
            -w zap-report.md \
            -a || true
      - name: Upload DAST report
        uses: actions/upload-artifact@v4
        with:
          name: dast-zap-report
          path: |
            zap-report.html
            zap-report.json
            zap-report.md
      
      # ========== UPLOAD TO DEFECTDOJO ==========
      - name: Upload DAST to DefectDojo
        if: always()
        run: |
          echo "üì§ Uploading DAST report to DefectDojo..."
          
          if [ -f zap-report.html ]; then
            echo "‚úÖ Found zap-report.json file"
            
            curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DEFECTDOJO_TOKEN" \
              -F "engagement=$DEFECTDOJO_ENGAGEMENT_ID" \
              -F "product=$DEFECTDOJO_PRODUCT_ID" \
              -F "scan_type=ZAP Scan" \
              -F "file=@zap-report.html" \
              --max-time 30 \
              || echo "‚ö†Ô∏è  DAST upload had issues, but continuing..."
              
            echo "‚úÖ DAST upload attempt completed"
          else
            echo "‚ùå zap-report.json not found, skipping upload"
          fi
      # ==========================================
      
      # ========== CLEANUP ==========
      - name: Cleanup Application
        if: always()
        run: |
          echo "üßπ Stopping application..."
          docker compose down || true
      # =============================